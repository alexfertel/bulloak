mod generator;
use bulloak_syntax::parse;
use super::config::Config;
use generator::generate;
use anyhow::Result;

/// Generates aztec-noir code from a `.tree` file. Has a uniform interface with the default
/// solidity backend.
/// TODO: should we define a Backend trait?
pub fn scaffold(text: &String, cfg: &Config) -> Result<String> {
    let forest = parse(text)?;
    generate(&forest, cfg)
}

#[cfg(test)]
mod test {
    use super::*;

    #[test]
    fn single_leaf() {
        let file_contents =
            "Module::Function\n└── When thing exists\n└── it should work";
        let output =
            scaffold(&file_contents.to_string(), &Config::default()).unwrap();
        let expected = r"
// Generated by bulloak

#[test]
unconstrained fn module_function_when_thing_exists() {
    // It should work.
}";
        assert_eq!(output.trim(), expected.trim());
    }

    #[test]
    fn two_roots() {
        let file_contents = r"
Module::Function
└── When thing exists
    └── it should work

Module::OtherFunction
└── When thing exists
    └── it should work";
        let output =
            scaffold(&file_contents.to_string(), &Config::default()).unwrap();
        let expected = r"
// Generated by bulloak

#[test]
unconstrained fn module_function_when_thing_exists() {
    // It should work.
}

#[test]
unconstrained fn module_other_function_when_thing_exists() {
    // It should work.
}";
        assert_eq!(output.trim(), expected.trim());
    }
}
